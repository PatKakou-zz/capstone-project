---
title: "Capstone Project"
output: html_notebook
---


# Load Libraries

```{r}
library(tidyverse)
library(descr)
library(Amelia)
library(lubridate)
```

# Load Data

```{r}
business <- read_csv("yelp_toronto_business.csv")
review <- read_csv("yelp_toronto_review.csv")
user <- read_csv("yelp_toronto_user.csv")
tip <- read_csv("yelp_toronto_tip.csv")
photo <- read_csv("yelp_toronto_photo.csv")
```

# Exploratory Data Analysis
## Business Data

```{r}
paste(class(business$state), 'class with', length(unique(business$state)), 'unique values and', sum(is.na(business$state)), 'missing values')
```

18,233 Observations and 13 Variables
$ address      character class with 14422 unique values and 283 missing values
$ business_id  character class with 18233 unique values and 0 missing values
$ categories   character class with 10028 unique values and 33 missing values
$ city         character class with 1 unique values and 0 missing values
$ is_open      integer class with 2 unique values and 0 missing values
$ latitude     numeric class with 15366 unique values and 1 missing values
$ longitude    numeric class with 15315 unique values and 1 missing values
$ name         character class with 15292 unique values and 0 missing values
$ neighborhood character class with 80 unique values and 3435 missing values
$ postal_code  character class with 5261 unique values and 117 missing values
$ review_count integer class with 380 unique values and 0 missing values
$ stars        numeric class with 9 unique values and 0 missing values
$ state        character class with 2 unique values and 0 missing values


```{r}
ggplot(data = business) +
  geom_point(mapping = aes(y = neighborhood, x = review_count, color = is_open))
```




```{r}
# Take a look on missing values
library(Amelia)
missmap(business, col = c('yellow','darkgreen'), main = 'Missing values vs observed')
```


## review Data

```{r}
neighborhood <- business %>% 
                  select(neighborhood, postal_code) %>% 
                  group_by(neighborhood) %>%
                  mutate(code = str_sub(postal_code, 1L, 6L)) %>%
                  arrange(code)
```

474,803 Observations and 9 Variables: 9
$ review_id   character class with 474803 unique values and 0 missing values
$ user_id     character class with 103262 unique values and 0 missing values
$ business_id character class with 18233 unique values and 0 missing values
$ stars       integer class with 5 unique values and 0 missing values
$ date        Date class from 2007-07-15 to 2018-07-02 and 0 missing values
$ text        character and 0 missing values
$ useful      integer class
$ funny       integer class
$ cool        integer class


```{r}
test <- neighborhood %>% 
          select(code, neighborhood, postal_code) %>%
          arrange(code)
```


```{r}
paste(class(review$useful), 'class with', length(unique(review$useful)), 'unique values and', sum(is.na(review$useful)), 'missing values')
```

```{r}
# Take a look on missing values
missmap(review, col = c('yellow','darkgreen'), main = 'Missing values vs observed')
```


```{r}
cb <- business %>% filter(is_open == 0)
```

```{r}
cb_rev <- inner_join(cb, review, by = "business_id")
```

```{r}
range_date <- cb_rev %>% 
                select(name, business_id, review_count, date) %>%
                group_by(business_id, name, review_count) %>% 
                summarise(duration = (max(year(date)) - min(year(date)))) %>%
                arrange(duration)
                
                
```



```{r}
test <- cb_rev %>% filter(business_id == "W8D-GbPDFCWkZpdlQoYH0g") %>%
          arrange(desc(date))
```














```{r}
resturant_neighborhood <- business %>% 
                            group_by(neighborhood) %>%
                            summarize(total_review = sum(review_count), mean_stars = round(mean(stars),1)) %>%
                            arrange(desc(total_review))
                           
```

```{r}
ggplot(business, aes(x = neighborhood)) +
geom_bar() + coord_flip()
```



```{r}
ggplot(business, aes(x = neighborhood)) +
  geom_bar(mapping = aes(x = neighborhood, fill = neighborhood))
```


```{r}
business2 %>% select(-starts_with("hours"), -starts_with("attribute")) %>% filter(city == 'Toronto') %>% unnest(categories) %>%
 select(name, categories)%>%group_by(categories)%>%summarise(n=n())%>%arrange(desc(n))%>%head(20)
```


```{r}
business2 %>% select(-starts_with("hours"), -starts_with("attribute")) %>% filter(city == 'Toronto') %>% unnest(categories = strsplit(categories, ",")) %>%
 select(name, categories)%>%group_by(categories)%>%summarise(n=n())%>%arrange(desc(n))%>%head(20)

#df %>% unnest(y = strsplit(y, ","))
```




```{r}
length(unique(business$categories))
```


```{r}
library(descr)
# Let filter based on transaction type "Renewal"
CrossTable(renew_channel$channel)
```


```{r}
business2 <- readRDS("business_data.rds")
```


```{r}
head(checkins)
```

```{r}
cat <- business2 %>% select(-starts_with("hours"), -starts_with("attribute")) %>% filter(city == 'Toronto') %>% unnest(categories = strsplit(categories, ",")) %>%
 select(name, categories)%>%group_by(categories)%>%summarise(n=n())%>%arrange(desc(n))
```


```{r}
cat2 <- business2 %>% select(-starts_with("hours"), -starts_with("attribute")) %>% filter(city == 'Toronto') %>% unnest(categories) %>%
 select(name, categories)%>%group_by(categories)%>%summarise(n=n())%>%arrange(desc(n))
```


```{r}
c <- colnames(business2$attributes)
test <- business2[, c('business_id', c)]
```


```{r}
closed_count <- review %>%
                  select(business_id, text) %>%
                  mutate(text_count = str_count(review$text, "closed down")) %>%
                  group_by(business_id, text_count) %>%
                  arrange(desc(text_count))
                  
```


