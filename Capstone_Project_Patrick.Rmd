---
title: "Capstone Project"
output: html_notebook
---


# Load Libraries

```{r}
library(tidyverse)
library(descr)
library(Amelia)
library(lubridate)
library(ggmap)
library(quantreg)
library(shapefiles)
```

# Load Data

```{r}
business <- read_csv("yelp_toronto_business.csv")
review <- read_csv("yelp_toronto_review.csv")
user <- read_csv("yelp_toronto_user.csv")
tip <- read_csv("yelp_toronto_tip.csv")
photo <- read_csv("yelp_toronto_photo.csv")
```

# Exploratory Data Analysis

Our focus will be on the business data, but we will use the review data to get some insights about businesses and will do some feature engineering to create useful variables for the model.

## review data

No missing values.

```{r}
glimpse(review)
```
```{r}
missmap(review, col = c('yellow','darkgreen'), main = 'Missing values vs observed')
```


## Business Data

```{r}
glimpse(business)
```


```{r}
missmap(business, col = c('yellow','darkgreen'), main = 'Missing values vs observed')
```

18,233 Observations and 13 Variables  
$ address      character class with 14422 unique values and 283 missing values  
$ business_id  character class with 18233 unique values and 0 missing values  
$ categories   character class with 10028 unique values and 33 missing values  
$ city         character class with 1 unique values and 0 missing values  
$ is_open      integer class with 2 unique values and 0 missing values  
$ latitude     numeric class with 15366 unique values and 1 missing values  
$ longitude    numeric class with 15315 unique values and 1 missing values  
$ name         character class with 15292 unique values and 0 missing values  
$ neighborhood character class with 80 unique values and 3435 missing values  
$ postal_code  character class with 5261 unique values and 117 missing values  
$ review_count integer class with 380 unique values and 0 missing values  
$ stars        numeric class with 9 unique values and 0 missing values  
$ state        character class with 2 unique values and 0 missing values  





```{r}
# converting "is_open" attribute from integer to factor and change values to yes or no
#lowering some character variable, converting "stars" from int to factor

business <- business %>% 
              mutate(is_open = as_factor(if_else(as.logical(is_open) == TRUE, "yes", "no")), 
                     categories = str_to_lower(categories),
                     name = str_to_lower(name),
                     neighborhood = str_to_lower(neighborhood),
                     stars =ordered(as_factor(as.character(stars)), levels = c("1", "1.5", "2", "2.5", "3", "3.5", "4", "4.5", "5"))
                     ) 
  
```

```{r}
ggplot(business, mapping = aes(stars, review_count, fill =is_open)) +
  geom_col(position = "stack")
```

Businesses "closed" received less reviews, and does not depend of rating. The graph below confirm that assumption. 



```{r}
ggplot(business, mapping = aes(stars, fill = is_open)) +
  geom_bar(position = "dodge")
```

Same distribution of rating, may be the closure is not related to the rating.

```{r}
ggplot(business, mapping = aes(neighborhood,  fill =is_open)) +
  geom_bar(position = "stack") +
  coord_flip()
```

```{r}
ggplot(business, mapping = aes(stars,  neighborhood, color = is_open)) +
  geom_count()
```



```{r}
neighborhood <- business %>% 
                  select(neighborhood, postal_code) %>% 
                  group_by(neighborhood) %>%
                  mutate(code = str_sub(postal_code, 1L, 6L)) %>%
                  arrange(code)
```




```{r}

map <- map_data(canada.cities$capital)
k <- ggplot(business, aes(fill = is_open))
k + geom_map(aes(map_id = canada.cities), map = map) +
expand_limits(x = business$longitude, y = business$latitude)



data <- data.frame(murder = USArrests$Murder,
state = tolower(rownames(USArrests)))
map <- map_data("canada.cities")
k <- ggplot(data, aes(fill = murder))
k + geom_map(aes(map_id = state), map = map) +
expand_limits(x = map$long, y = map$lat)
map_id, alpha, color, fill, linetype, size

map <- maps::canada.cities

```








```{r}
test <- neighborhood %>% 
          select(code, neighborhood, postal_code) %>%
          arrange(code)
```


```{r}
range_date <- cb_rev %>% 
                select(name, business_id, review_count, date) %>%
                group_by(business_id, name, review_count) %>% 
                summarise(duration = (max(year(date)) - min(year(date)))) %>%
                arrange(duration)
                
                
```



```{r}
restaurant_neighborhood <- business %>% 
                            group_by(neighborhood) %>%
                            summarize(total_review = sum(review_count), mean_stars = round(mean(stars),1)) %>%
                            arrange(desc(total_review))
                           
```

```{r}
ggplot(business, mapping = aes(x = neighborhood, fill = is_open)) +
geom_bar() + coord_flip()
```



```{r}
ggplot(business, mapping = aes(x = neighborhood)) +
  geom_bar(aes(fill = stars))
```


```{r}
business2 %>% select(-starts_with("hours"), -starts_with("attribute")) %>% filter(city == 'Toronto') %>% unnest(categories) %>%
 select(name, categories)%>%group_by(categories)%>%summarise(n=n())%>%arrange(desc(n))%>%head(20)
```


```{r}
business2 %>% select(-starts_with("hours"), -starts_with("attribute")) %>% filter(city == 'Toronto') %>% unnest(categories = strsplit(categories, ",")) %>%
 select(name, categories)%>%group_by(categories)%>%summarise(n=n())%>%arrange(desc(n))%>%head(20)

#df %>% unnest(y = strsplit(y, ","))
```




```{r}
length(unique(business$categories))
```


```{r}
library(descr)
# Let filter based on transaction type "Renewal"
CrossTable(renew_channel$channel)
```


```{r}
business2 <- readRDS("business_data.rds")
```


```{r}
head(checkins)
```

```{r}
cat <- business2 %>% select(-starts_with("hours"), -starts_with("attribute")) %>% filter(city == 'Toronto') %>% unnest(categories = strsplit(categories, ",")) %>%
 select(name, categories)%>%group_by(categories)%>%summarise(n=n())%>%arrange(desc(n))
```


```{r}
cat2 <- business2 %>% select(-starts_with("hours"), -starts_with("attribute")) %>% filter(city == 'Toronto') %>% unnest(categories) %>%
 select(name, categories)%>%group_by(categories)%>%summarise(n=n())%>%arrange(desc(n))
```


```{r}
c <- colnames(business2$attributes)
test <- business2[, c('business_id', c)]
```


```{r}
closed_count <- review %>%
                  select(business_id, text) %>%
                  mutate(text_count = str_count(review$text, "closed down")) %>%
                  group_by(business_id, text_count) %>%
                  arrange(desc(text_count))
                  
```


# maps

```{r}
library(cancensus)
library(sf)
# retrieve sf dataframe
toronto <- get_census(dataset='CA16', regions=list(CMA="35535"),
                         vectors="v_CA16_2397", level='CSD', quiet = TRUE, 
                         geo_format = 'sf', labels = 'short')
```

```{r}
business %>% filter(is.na(longitude) == TRUE)
```
M5H 4G1/Coordinates
43.6508° N, 79.3854° W (lat: 43.6508, lon: -79.3854)




```{r}

```


