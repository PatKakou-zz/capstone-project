---
title: "Capstone Project"
output: 
  html_notebook:
    fig_width: 6 
    fig_height: 4
    
---

```{r}
knitr::opts_chunk$set(fig.width=12, fig.height=8) 
```


# Load Libraries

```{r}
library(tidyverse)
library(descr)
library(Amelia)
library(lubridate)
library(ggmap)
library(quantreg)
library(shapefiles)
library(leaflet)
library(stringi)
library(ngram)
library(qdap)
library(rgdal)
library(plotly)
library(data.table)
```

# Load Data

```{r}
business <- read_csv("yelp_toronto_business.csv")
review <- read_csv("yelp_toronto_review.csv")
```

# Exploratory Data Analysis

Our focus will be on the business data, but we will use the review data to get some insights about businesses and will do some feature engineering to create useful variables for the model.

## review data

```{r}
glimpse(review)
```

```{r}
# Are there any missing values?
missmap(review, col = c('yellow','darkgreen'), main = 'Missing values vs observed')
```
Sounds good, there are No missing values in the review dataset. Later we will check if some variable will help for building our model.

```{r}
review <- review %>%
                  mutate(word_count = str_count(review$text, "\\w+")) %>%
                  group_by(business_id, word_count) %>%
                  arrange(desc(word_count))
                  
```


## Business Data

```{r}
glimpse(business)
```

```{r}
missing <- data.table(pmiss = sapply(business, function(x) { (sum(is.na(x)) / length(x)) }),
                      column = names(business))
  
p <- ggplot(missing,aes(x = reorder(column, -pmiss), y = pmiss)) +
      geom_bar(stat = 'identity', fill = 'steelblue') + 
      scale_y_continuous(labels = scales::percent) + 
      theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
      labs(
        title='Missing data by feature',
        x='Feature',
        y='% missing')
ggplotly(p)
```

We have that summary for the business data:
18,233 Observations and 13 Variables  
$ address      character class with 14422 unique values and 283 missing values  
$ business_id  character class with 18233 unique values and 0 missing values  
$ categories   character class with 10028 unique values and 33 missing values  
$ city         character class with 1 unique values and 0 missing values  
$ is_open      integer class with 2 unique values and 0 missing values  
$ latitude     numeric class with 15366 unique values and 1 missing values  
$ longitude    numeric class with 15315 unique values and 1 missing values  
$ name         character class with 15292 unique values and 0 missing values  
$ neighborhood character class with 80 unique values and 3435 missing values  
$ postal_code  character class with 5261 unique values and 117 missing values  
$ review_count integer class with 380 unique values and 0 missing values  
$ stars        numeric class with 9 unique values and 0 missing values  
$ state        character class with 2 unique values and 0 missing values  



```{r}
# correcting coordinates
business[which(business$address == "2138 Queen Street E"),] <- business %>% 
                                                        filter(business$address == "2138 Queen Street E") %>%
                                                        mutate(longitude = -79.293425, latitude = 43.671584)

#adding coordinates for the postal code M5H 4G1 (lon: -79.3854, lat: 43.6508)  
business[which(is.na(business$longitude) == TRUE),] <- business %>% 
                                                        filter(is.na(longitude) == TRUE) %>%
                                                        mutate(longitude = -79.3854, latitude = 43.6508)

# converting "is_open" attribute from integer to factor and change values to yes or no
#lowering some character variable, converting "stars" from int to factor

business <- business %>% 
              mutate(is_open = as_factor(if_else(as.logical(is_open) == TRUE, "yes", "no")), 
                     categories = str_to_lower(categories),
                     name = str_to_lower(name),
                     neighborhood = str_to_lower(neighborhood),
                     stars =ordered(as_factor(as.character(stars)), levels = c("1", "1.5", "2", "2.5", "3", "3.5", "4", "4.5", "5"))
                     ) 

```

Let check the distribution in the target variable. How many businesses are open? How many are closed?

```{r, fig.width=3, fig.height=5}
p <- ggplot(business, aes(x = is_open)) +
      geom_bar(aes(fill = is_open))
ggplotly(p)
```

14023 businesses are open (77%) and 4210 closed (23%). Our target variable is imbalanced.

```{r}
# star rating distribution
p <- ggplot(business, mapping = aes(stars)) +
      geom_bar(aes(fill = stars)) +
      labs(title ="Star rating distribution")

ggplotly(p)
```
Around 70% of the businesses got a rating between 3 and 4.5


```{r}
# The distribution of number of reviews
#we have applied log since the distribution is skewed
p <- ggplot(data = business, aes(x = review_count)) + 
      geom_histogram(bins = 50, fill = "darkgreen", binwidth = 25) +
      #geom_density(alpha=.2, fill="#FF6666") +
      scale_y_log10() +
      labs(title ="Distribution of reviews")


ggplotly(p)
#ggsave("reviews_dist.png", width = 10, height = 5)

```

Businesses "closed" received less reviews, and does not depend of rating. The graph below confirms that assumption. 

```{r}
p <- ggplot(business, mapping = aes(stars, fill = is_open)) +
  geom_bar(position = "dodge") +
  labs( x = "Star rating", y = "Number of businesses", title ="Star rating distribution business open/closed")

ggplotly(p)
#ggsave("stars_dist2.png", width = 5, height = 5)
```

Same distribution of rating, may be the closure is not related to the rating.

```{r}
p <- ggplot(business, mapping = aes(neighborhood,  fill =is_open)) +
  geom_bar(position = "stack") +
  coord_flip()

ggplotly(p)
```

```{r}
center_long = median(business$longitude, na.rm = TRUE)
center_lat = median(business$latitude, na.rm = TRUE)

leaflet(business) %>% 
      addTiles()%>%
      #addProviderTiles("Esri.NatGeoWorldMap") %>%
      addCircles(lng = ~ longitude, lat = ~latitude, radius = ~sqrt(review_count)) %>%
      setView(lng = center_long, lat = center_lat, zoom = 10)

```


Leading Business Categories:

Let's look at the leading business categories in out dataset. A business is linked to multiple categories in our dataset, so we have to do a bit of preprocessing, which is simple using dplyr package.

```{r}
categorie <- business %>% 
                unnest(categories = str_split(categories, ",")) %>%
                mutate(categories = str_trim(categories,side = "both")) %>%
                select(name, categories) %>% 
                group_by(categories) %>% 
                summarise(n=n()) %>% 
                arrange(desc(n)) %>% 
                head(25)

p <- ggplot(categorie, aes(x = reorder(categories, n), y = n)) +
      geom_col(aes(fill = n)) +
      scale_fill_gradientn(colours=RColorBrewer::brewer.pal(11,"Spectral")) +
      coord_flip()



ggplotly(p)
```


```{r}

```

